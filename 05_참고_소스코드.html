<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Caliper Works</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #141414;
      --bg-card: #1a1a1a;
      --bg-card-hover: #222222;
      --bg-elevated: #252525;
      --text-primary: #f0f0f0;
      --text-secondary: #999999;
      --text-muted: #666666;
      --accent: #FF6B35;
      --accent-dim: rgba(255, 107, 53, 0.15);
      --accent-glow: rgba(255, 107, 53, 0.3);
      --border: #2a2a2a;
      --border-light: #333333;
      --success: #34D399;
      --warning: #FBBF24;
      --info: #60A5FA;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ===== App Shell ===== */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding-top: var(--safe-top);
      background: rgba(10, 10, 10, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .logo-text {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: -0.5px;
      color: var(--text-primary);
    }

    .logo-text span {
      color: var(--accent);
    }

    .header-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    /* ===== Search Bar ===== */
    .search-container {
      position: fixed;
      top: calc(57px + var(--safe-top));
      left: 0;
      right: 0;
      z-index: 99;
      background: rgba(10, 10, 10, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 8px 16px 12px;
    }

    .search-box {
      max-width: 600px;
      margin: 0 auto;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 16px 14px 44px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 15px;
      font-family: 'Noto Sans KR', sans-serif;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }

    .search-clear {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--bg-elevated);
      border: none;
      color: var(--text-secondary);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .search-clear.visible { display: flex; }

    /* ===== Main Content ===== */
    .main-content {
      padding-top: calc(120px + var(--safe-top));
      padding-bottom: calc(24px + var(--safe-bottom));
      max-width: 600px;
      margin: 0 auto;
      padding-left: 16px;
      padding-right: 16px;
      min-height: 100dvh;
    }

    /* ===== Product List ===== */
    .product-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
      padding-left: 4px;
    }

    .product-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .product-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .product-card:active {
      transform: scale(0.98);
      background: var(--bg-card-hover);
    }

    .product-thumb {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-sm);
      background: var(--bg-elevated);
      flex-shrink: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-thumb-placeholder {
      font-size: 20px;
      color: var(--text-muted);
    }

    .product-info {
      flex: 1;
      min-width: 0;
    }

    .product-code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      line-height: 1.2;
    }

    .product-model {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-tags {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .tag {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--bg-elevated);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .product-arrow {
      color: var(--text-muted);
      flex-shrink: 0;
    }

    /* ===== Detail View ===== */
    .detail-view {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 200;
      background: var(--bg-primary);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-view.active {
      transform: translateX(0);
    }

    .detail-header {
      position: sticky;
      top: 0;
      z-index: 10;
      padding-top: var(--safe-top);
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }

    .detail-header-inner {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      font-family: 'Noto Sans KR', sans-serif;
      font-weight: 500;
      padding: 4px 0;
    }

    .detail-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 700;
    }

    .detail-body {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 16px 40px;
    }

    /* Product Image */
    .detail-image {
      width: 100%;
      aspect-ratio: 4/3;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      margin: 16px 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }

    .detail-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .detail-image-placeholder {
      font-size: 48px;
      color: var(--text-muted);
    }

    /* Info Section */
    .section {
      margin-top: 20px;
    }

    .section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .info-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
    }

    .info-item.full-width {
      grid-column: 1 / -1;
    }

    .info-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .info-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      word-break: break-all;
    }

    /* BOM List */
    .bom-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bom-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
    }

    .bom-item:active {
      transform: scale(0.98);
      background: var(--bg-card-hover);
    }

    .bom-item-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bom-type-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      min-width: 52px;
      text-align: center;
    }

    .bom-type-piston { background: rgba(255, 107, 53, 0.15); color: #FF6B35; }
    .bom-type-seal { background: rgba(96, 165, 250, 0.15); color: #60A5FA; }
    .bom-type-boot { background: rgba(52, 211, 153, 0.15); color: #34D399; }
    .bom-type-pin { background: rgba(251, 191, 36, 0.15); color: #FBBF24; }
    .bom-type-pinboot { background: rgba(167, 139, 250, 0.15); color: #A78BFA; }

    .bom-code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      font-weight: 600;
    }

    .bom-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .bom-arrow {
      color: var(--text-muted);
      font-size: 12px;
    }

    .bom-empty {
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
    }

    /* Location Cards */
    .location-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .location-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      text-align: center;
    }

    .location-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .location-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 700;
      color: var(--warning);
    }

    .location-value.empty {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* ===== Part Detail View ===== */
    .part-detail-view {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 300;
      background: var(--bg-primary);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .part-detail-view.active {
      transform: translateX(0);
    }

    .part-spec-coming {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .part-spec-coming-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .part-spec-coming-text {
      font-size: 14px;
      line-height: 1.6;
    }

    .part-used-in {
      margin-top: 8px;
    }

    .part-used-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.15s;
    }

    .part-used-item:active {
      background: var(--bg-card-hover);
    }

    /* ===== Loading & Empty States ===== */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .empty-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .empty-desc {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* ===== Config Modal ===== */
    .config-overlay {
      position: fixed;
      inset: 0;
      z-index: 500;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: flex-end;
      justify-content: center;
    }

    .config-overlay.active {
      display: flex;
    }

    .config-modal {
      background: var(--bg-card);
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 600px;
      padding: 24px 20px calc(24px + var(--safe-bottom));
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .config-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .config-field {
      margin-bottom: 16px;
    }

    .config-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .config-input {
      width: 100%;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
    }

    .config-input:focus {
      border-color: var(--accent);
    }

    .config-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    .config-btn {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .config-btn-cancel {
      background: var(--bg-elevated);
      color: var(--text-secondary);
    }

    .config-btn-save {
      background: var(--accent);
      color: white;
    }

    .config-status {
      margin-top: 12px;
      padding: 10px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      display: none;
    }

    .config-status.success {
      display: block;
      background: rgba(52, 211, 153, 0.15);
      color: var(--success);
    }

    .config-status.error {
      display: block;
      background: rgba(239, 68, 68, 0.15);
      color: #EF4444;
    }

    /* ===== Scrollbar ===== */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* ===== Initial Setup Screen ===== */
    .setup-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100dvh;
      padding: 40px 24px;
      text-align: center;
    }

    .setup-logo {
      width: 80px;
      height: 80px;
      background: var(--accent);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px var(--accent-glow);
    }

    .setup-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .setup-title span { color: var(--accent); }

    .setup-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .setup-form {
      width: 100%;
      max-width: 400px;
    }

    .setup-field {
      text-align: left;
      margin-bottom: 16px;
    }

    .setup-field label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .setup-field input {
      width: 100%;
      padding: 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
    }

    .setup-field input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .setup-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      line-height: 1.4;
    }

    .setup-btn {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
      font-family: 'Noto Sans KR', sans-serif;
      transition: opacity 0.2s;
    }

    .setup-btn:active { opacity: 0.8; }

    .setup-error {
      margin-top: 12px;
      font-size: 13px;
      color: #EF4444;
      display: none;
    }

    /* Hide/Show */
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- ===== SETUP SCREEN ===== -->
  <div id="setupScreen" class="setup-screen">
    <div class="setup-logo">ğŸ”§</div>
    <div class="setup-title">Caliper <span>Works</span></div>
    <div class="setup-desc">
      ë¸Œë ˆì´í¬ ìº˜ë¦¬í¼ ìƒì‚° ì°¸ê³  ì•±<br>
      Firebase í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
    </div>
    <div class="setup-form">
      <div class="setup-field">
        <label>Firebase API Key</label>
        <input type="text" id="setupApiKey" placeholder="AIzaSy...">
      </div>
      <div class="setup-field">
        <label>Project ID</label>
        <input type="text" id="setupProjectId" placeholder="your-project-id">
        <div class="setup-hint">Firebase Console â†’ í”„ë¡œì íŠ¸ ì„¤ì •ì—ì„œ í™•ì¸</div>
      </div>
      <div class="setup-field">
        <label>Storage Bucket</label>
        <input type="text" id="setupBucket" placeholder="your-project.appspot.com">
        <div class="setup-hint">Firebase Storageì—ì„œ ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¬ ë•Œ ì‚¬ìš©</div>
      </div>
      <button class="setup-btn" onclick="saveConfig()">ì—°ê²°í•˜ê¸°</button>
      <div class="setup-error" id="setupError"></div>
    </div>
  </div>

  <!-- ===== MAIN APP ===== -->
  <div id="mainApp" class="hidden">
    <!-- Header -->
    <header class="app-header">
      <div class="header-inner">
        <div class="logo">
          <div class="logo-icon">ğŸ”§</div>
          <div class="logo-text">Caliper <span>Works</span></div>
        </div>
        <button class="header-badge" onclick="showConfig()" style="cursor:pointer; border:none;">âš™ ì„¤ì •</button>
      </div>
    </header>

    <!-- Search -->
    <div class="search-container">
      <div class="search-box">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input type="text" class="search-input" id="searchInput" placeholder="ì½”ë“œ, ëª¨ë¸ëª…, ì°¨ì¢… ê²€ìƒ‰..." autocomplete="off">
        <button class="search-clear" id="searchClear" onclick="clearSearch()">âœ•</button>
      </div>
    </div>

    <!-- Content -->
    <main class="main-content" id="mainContent">
      <div class="loading-state" id="loadingState">
        <div class="spinner"></div>
        <div class="loading-text">ì œí’ˆ ë°ì´í„° ë¡œë”© ì¤‘...</div>
      </div>
      <div id="productCount" class="product-count hidden"></div>
      <div id="productList" class="product-list"></div>
      <div id="emptyState" class="empty-state hidden">
        <div class="empty-icon">ğŸ”</div>
        <div class="empty-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-desc">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”</div>
      </div>
    </main>
  </div>

  <!-- ===== PRODUCT DETAIL VIEW ===== -->
  <div class="detail-view" id="detailView">
    <header class="detail-header">
      <div class="detail-header-inner">
        <button class="back-btn" onclick="closeDetail()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          ëª©ë¡
        </button>
        <div class="detail-title" id="detailTitle"></div>
      </div>
    </header>
    <div class="detail-body" id="detailBody"></div>
  </div>

  <!-- ===== PART DETAIL VIEW ===== -->
  <div class="part-detail-view" id="partDetailView">
    <header class="detail-header">
      <div class="detail-header-inner">
        <button class="back-btn" onclick="closePartDetail()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          ì œí’ˆ
        </button>
        <div class="detail-title" id="partDetailTitle"></div>
      </div>
    </header>
    <div class="detail-body" id="partDetailBody"></div>
  </div>

  <!-- ===== CONFIG MODAL ===== -->
  <div class="config-overlay" id="configOverlay" onclick="closeConfig(event)">
    <div class="config-modal" onclick="event.stopPropagation()">
      <div class="config-title">âš™ Firebase ì„¤ì •</div>
      <div class="config-field">
        <div class="config-label">API Key</div>
        <input type="text" class="config-input" id="cfgApiKey">
      </div>
      <div class="config-field">
        <div class="config-label">Project ID</div>
        <input type="text" class="config-input" id="cfgProjectId">
      </div>
      <div class="config-field">
        <div class="config-label">Storage Bucket</div>
        <input type="text" class="config-input" id="cfgBucket">
      </div>
      <div class="config-buttons">
        <button class="config-btn config-btn-cancel" onclick="closeConfig()">ì·¨ì†Œ</button>
        <button class="config-btn config-btn-save" onclick="updateConfig()">ì €ì¥</button>
      </div>
      <div class="config-status" id="cfgStatus"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
    // ===== State =====
    let db = null;
    let storage = null;
    let allProducts = [];
    let filteredProducts = [];
    let currentProduct = null;
    let imageCache = {};

    // ===== Config Management =====
    function getConfig() {
      const raw = localStorage.getItem('cw_config');
      return raw ? JSON.parse(raw) : null;
    }

    function saveConfig() {
      const apiKey = document.getElementById('setupApiKey').value.trim();
      const projectId = document.getElementById('setupProjectId').value.trim();
      const bucket = document.getElementById('setupBucket').value.trim();
      const errEl = document.getElementById('setupError');

      if (!apiKey || !projectId) {
        errEl.textContent = 'API Keyì™€ Project IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.';
        errEl.style.display = 'block';
        return;
      }

      const config = { apiKey, projectId, bucket: bucket || `${projectId}.appspot.com` };
      localStorage.setItem('cw_config', JSON.stringify(config));
      initApp(config);
    }

    function showConfig() {
      const config = getConfig();
      if (config) {
        document.getElementById('cfgApiKey').value = config.apiKey;
        document.getElementById('cfgProjectId').value = config.projectId;
        document.getElementById('cfgBucket').value = config.bucket;
      }
      document.getElementById('configOverlay').classList.add('active');
    }

    function closeConfig(e) {
      if (e && e.target !== document.getElementById('configOverlay')) return;
      document.getElementById('configOverlay').classList.remove('active');
    }

    function updateConfig() {
      const apiKey = document.getElementById('cfgApiKey').value.trim();
      const projectId = document.getElementById('cfgProjectId').value.trim();
      const bucket = document.getElementById('cfgBucket').value.trim();
      const statusEl = document.getElementById('cfgStatus');

      if (!apiKey || !projectId) {
        statusEl.className = 'config-status error';
        statusEl.textContent = 'API Keyì™€ Project IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.';
        return;
      }

      const config = { apiKey, projectId, bucket: bucket || `${projectId}.appspot.com` };
      localStorage.setItem('cw_config', JSON.stringify(config));
      statusEl.className = 'config-status success';
      statusEl.textContent = 'ì €ì¥ ì™„ë£Œ! ì•±ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...';
      setTimeout(() => location.reload(), 1000);
    }

    // ===== Init Firebase =====
    function initFirebase(config) {
      if (firebase.apps.length) {
        firebase.app().delete().then(() => createFirebaseApp(config));
      } else {
        createFirebaseApp(config);
      }
    }

    function createFirebaseApp(config) {
      const app = firebase.initializeApp({
        apiKey: config.apiKey,
        projectId: config.projectId,
        storageBucket: config.bucket
      });
      db = firebase.firestore();
      storage = firebase.storage();
    }

    // ===== Init App =====
    async function initApp(config) {
      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      initFirebase(config);
      await loadProducts();
    }

    // ===== Load Products =====
    async function loadProducts() {
      const loadingEl = document.getElementById('loadingState');
      const countEl = document.getElementById('productCount');
      const listEl = document.getElementById('productList');

      loadingEl.classList.remove('hidden');
      countEl.classList.add('hidden');
      listEl.innerHTML = '';

      try {
        const snapshot = await db.collection('products').orderBy('ì½”ë“œ').get();
        allProducts = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          data._id = doc.id;
          allProducts.push(data);
        });

        loadingEl.classList.add('hidden');
        filteredProducts = [...allProducts];
        renderProductList();
      } catch (err) {
        loadingEl.innerHTML = `
          <div class="empty-icon">âš ï¸</div>
          <div class="empty-title">ì—°ê²° ì‹¤íŒ¨</div>
          <div class="empty-desc">${err.message}<br><br>
            <button class="config-btn config-btn-save" onclick="showConfig()" style="display:inline-block;width:auto;padding:8px 20px;">ì„¤ì • ë³€ê²½</button>
          </div>
        `;
      }
    }

    // ===== Render Product List =====
    function renderProductList() {
      const countEl = document.getElementById('productCount');
      const listEl = document.getElementById('productList');
      const emptyEl = document.getElementById('emptyState');

      if (filteredProducts.length === 0) {
        countEl.classList.add('hidden');
        listEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
      }

      emptyEl.classList.add('hidden');
      countEl.classList.remove('hidden');
      countEl.textContent = `${filteredProducts.length}ê°œ ì œí’ˆ`;

      listEl.innerHTML = filteredProducts.map(p => {
        const code = p['ì½”ë“œ'] || p._id;
        const model = p['ì½”ë“œëª¨ë¸ëª…'] || '';
        const maker = p['ì œì¡°ì‚¬'] || '';
        const type = p['íƒ€ì…'] || '';
        const system = p['ì‹œìŠ¤í…œ'] || '';

        return `
          <div class="product-card" onclick="openDetail('${p._id}')">
            <div class="product-thumb">
              <div class="product-thumb-placeholder">ğŸ“¦</div>
            </div>
            <div class="product-info">
              <div class="product-code">${code}</div>
              <div class="product-model">${model.replace(code + '_', '')}</div>
              <div class="product-tags">
                ${maker ? `<span class="tag">${maker}</span>` : ''}
                ${type ? `<span class="tag">${type}</span>` : ''}
                ${system ? `<span class="tag">${system}</span>` : ''}
              </div>
            </div>
            <div class="product-arrow">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg>
            </div>
          </div>
        `;
      }).join('');

      // Load thumbnails asynchronously
      filteredProducts.forEach((p, i) => {
        loadProductImage(p, i);
      });
    }

    // ===== Load Product Image =====
    async function loadProductImage(product, index) {
      const code = product['ì½”ë“œ'] || product._id;
      const thumbEl = document.querySelectorAll('.product-thumb')[index];
      if (!thumbEl) return;

      // Check if there's an image URL in the product data
      const imgField = product['ì´ë¯¸ì§€'] || product['ì´ë¯¸ì§€1'] || product['alt=media'] || '';

      if (imgField && imgField.startsWith('http')) {
        thumbEl.innerHTML = `<img src="${imgField}" alt="${code}" onerror="this.parentElement.innerHTML='<div class=\\'product-thumb-placeholder\\'>ğŸ“¦</div>'">`;
        return;
      }

      // Try Firebase Storage
      if (storage) {
        try {
          const paths = [`products/${code}.jpg`, `products/${code}.png`, `products/${code}.JPG`];
          for (const path of paths) {
            try {
              const url = await storage.ref(path).getDownloadURL();
              thumbEl.innerHTML = `<img src="${url}" alt="${code}">`;
              imageCache[code] = url;
              return;
            } catch(e) { continue; }
          }
        } catch(e) {}
      }
    }

    // ===== Search =====
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');
    let searchTimeout;

    searchInput.addEventListener('input', () => {
      const val = searchInput.value.trim();
      searchClear.classList.toggle('visible', val.length > 0);

      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        filterProducts(val);
      }, 200);
    });

    function clearSearch() {
      searchInput.value = '';
      searchClear.classList.remove('visible');
      filteredProducts = [...allProducts];
      renderProductList();
      searchInput.focus();
    }

    function filterProducts(query) {
      if (!query) {
        filteredProducts = [...allProducts];
      } else {
        const q = query.toLowerCase();
        filteredProducts = allProducts.filter(p => {
          const searchFields = [
            p['ì½”ë“œ'], p['ì½”ë“œëª¨ë¸ëª…'], p['ì œì¡°ì‚¬'], p['ì‹œìŠ¤í…œ'],
            p['ê²€ìƒ‰ì°½ë‚´ìš©'], p['í˜¸í™˜ì°¨ì¢…'], p['íƒ€ì…'],
            p['í•˜ìš°ì§•'], p['ìºë¦¬ì–´'],
            p['í”¼ìŠ¤í†¤1'], p['í”¼ìŠ¤í†¤2'], p['í”¼ìŠ¤í†¤3'],
            p['ì”°1'], p['ì”°2'], p['ì”°3'],
            p['ë¶€íŠ¸1'], p['ë¶€íŠ¸2'], p['ë¶€íŠ¸3'],
            p['í•€1'], p['í•€2'],
            p['í•€ë¶€íŠ¸1'], p['í•€ë¶€íŠ¸2'], p['í•€ë¶€íŠ¸3']
          ];
          return searchFields.some(f => f && String(f).toLowerCase().includes(q));
        });
      }
      renderProductList();
    }

    // ===== Product Detail =====
    function openDetail(id) {
      const product = allProducts.find(p => p._id === id);
      if (!product) return;
      currentProduct = product;

      const code = product['ì½”ë“œ'] || id;
      document.getElementById('detailTitle').textContent = code;

      const body = document.getElementById('detailBody');
      body.innerHTML = buildDetailHTML(product);
      document.getElementById('detailView').classList.add('active');
      document.body.style.overflow = 'hidden';

      // Load detail image
      loadDetailImage(product);
    }

    function buildDetailHTML(p) {
      const code = p['ì½”ë“œ'] || p._id;
      const model = (p['ì½”ë“œëª¨ë¸ëª…'] || '').replace(code + '_', '');

      // BOM items
      const bomTypes = [
        { key: 'í”¼ìŠ¤í†¤', prefix: 'í”¼ìŠ¤í†¤', colorClass: 'bom-type-piston', max: 3 },
        { key: 'ì”°', prefix: 'ì”°', colorClass: 'bom-type-seal', max: 3 },
        { key: 'ë¶€íŠ¸', prefix: 'ë¶€íŠ¸', colorClass: 'bom-type-boot', max: 3 },
        { key: 'í•€', prefix: 'í•€', colorClass: 'bom-type-pin', max: 2 },
        { key: 'í•€ë¶€íŠ¸', prefix: 'í•€ë¶€íŠ¸', colorClass: 'bom-type-pinboot', max: 3 },
      ];

      let bomHTML = '';
      bomTypes.forEach(bt => {
        for (let i = 1; i <= bt.max; i++) {
          const val = p[`${bt.prefix}${i}`];
          if (val && val.trim()) {
            bomHTML += `
              <div class="bom-item" onclick="openPartDetail('${val.trim()}', '${bt.key}')">
                <div class="bom-item-left">
                  <span class="bom-type-badge ${bt.colorClass}">${bt.key}${i}</span>
                  <div>
                    <div class="bom-code">${val.trim()}</div>
                  </div>
                </div>
                <span class="bom-arrow">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg>
                </span>
              </div>
            `;
          }
        }
      });

      if (!bomHTML) {
        bomHTML = '<div class="bom-empty">ë“±ë¡ëœ ë¶€ì†í’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>';
      }

      // Location
      const locations = [
        { label: 'ì™„ì œí’ˆ', value: p['ì™„ì œí’ˆ ìœ„ì¹˜'] },
        { label: 'í•˜ìš°ì§•', value: p['í•˜ìš°ì§• ìœ„ì¹˜'] },
        { label: 'ìºë¦¬ì–´', value: p['ìºë¦¬ì–´ ìœ„ì¹˜'] },
        { label: 'ì°½ê³ ', value: p['ì°½ê³  ìœ„ì¹˜'] },
        { label: 'ê³ í’ˆ', value: p['ê³ í’ˆ ìœ„ì¹˜'] },
      ];

      let locHTML = locations.map(l => `
        <div class="location-card">
          <div class="location-label">${l.label}</div>
          <div class="location-value ${!l.value || l.value === '-' ? 'empty' : ''}">${l.value && l.value !== '-' ? l.value : '-'}</div>
        </div>
      `).join('');

      return `
        <div class="detail-image" id="detailImage">
          <div class="detail-image-placeholder">ğŸ“¦</div>
        </div>

        <div class="section">
          <div class="section-title">ì œí’ˆ ì •ë³´</div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">ì½”ë“œ</div>
              <div class="info-value">${code}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ëª¨ë¸ëª…</div>
              <div class="info-value">${model || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ì œì¡°ì‚¬</div>
              <div class="info-value">${p['ì œì¡°ì‚¬'] || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ì‹œìŠ¤í…œ</div>
              <div class="info-value">${p['ì‹œìŠ¤í…œ'] || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">íƒ€ì…</div>
              <div class="info-value">${p['íƒ€ì…'] || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ë‹ˆí”Œ</div>
              <div class="info-value">${p['ë‹ˆí”Œ'] || '-'}</div>
            </div>
            ${p['ê·œê²©'] ? `<div class="info-item full-width"><div class="info-label">ê·œê²©</div><div class="info-value">${p['ê·œê²©']}</div></div>` : ''}
            ${p['í•˜ìš°ì§•'] ? `<div class="info-item"><div class="info-label">í•˜ìš°ì§•</div><div class="info-value">${p['í•˜ìš°ì§•']}</div></div>` : ''}
            ${p['ìºë¦¬ì–´'] ? `<div class="info-item"><div class="info-label">ìºë¦¬ì–´</div><div class="info-value">${p['ìºë¦¬ì–´']}</div></div>` : ''}
            ${p['í˜¸í™˜ì°¨ì¢…'] ? `<div class="info-item full-width"><div class="info-label">í˜¸í™˜ì°¨ì¢…</div><div class="info-value">${p['í˜¸í™˜ì°¨ì¢…']}</div></div>` : ''}
            ${p['ê²€ìƒ‰ì°½ë‚´ìš©'] ? `<div class="info-item full-width"><div class="info-label">ê²€ìƒ‰ì°¸ê³ </div><div class="info-value" style="font-size:12px;">${p['ê²€ìƒ‰ì°½ë‚´ìš©']}</div></div>` : ''}
          </div>
        </div>

        <div class="section">
          <div class="section-title">BOM (ë¶€ì†í’ˆ)</div>
          <div class="bom-list">${bomHTML}</div>
        </div>

        <div class="section">
          <div class="section-title">ìœ„ì¹˜ ì •ë³´</div>
          <div class="location-grid">${locHTML}</div>
        </div>

        ${p['ì œí’ˆê´€ë ¨ ì ìš”'] ? `
        <div class="section">
          <div class="section-title">ë©”ëª¨</div>
          <div class="info-item full-width">
            <div class="info-value" style="font-size:13px; font-family:'Noto Sans KR',sans-serif; font-weight:400; line-height:1.6;">${p['ì œí’ˆê´€ë ¨ ì ìš”']}</div>
          </div>
        </div>
        ` : ''}
      `;
    }

    async function loadDetailImage(product) {
      const code = product['ì½”ë“œ'] || product._id;
      const el = document.getElementById('detailImage');
      if (!el) return;

      // Check cache
      if (imageCache[code]) {
        el.innerHTML = `<img src="${imageCache[code]}" alt="${code}">`;
        return;
      }

      // Check data fields
      const imgField = product['ì´ë¯¸ì§€'] || product['ì´ë¯¸ì§€1'] || product['alt=media'] || '';
      if (imgField && imgField.startsWith('http')) {
        el.innerHTML = `<img src="${imgField}" alt="${code}">`;
        return;
      }

      // Try Storage
      if (storage) {
        const paths = [`products/${code}.jpg`, `products/${code}.png`, `products/${code}.JPG`, `products/${code}.jpeg`];
        for (const path of paths) {
          try {
            const url = await storage.ref(path).getDownloadURL();
            el.innerHTML = `<img src="${url}" alt="${code}">`;
            imageCache[code] = url;
            return;
          } catch(e) { continue; }
        }
      }
    }

    function closeDetail() {
      document.getElementById('detailView').classList.remove('active');
      document.body.style.overflow = '';
      currentProduct = null;
    }

    // ===== Part Detail =====
    async function openPartDetail(partCode, partType) {
      document.getElementById('partDetailTitle').textContent = partCode;
      const body = document.getElementById('partDetailBody');

      // Find products that use this part
      const usedIn = allProducts.filter(p => {
        const fields = [];
        for (let i = 1; i <= 3; i++) {
          const prefixes = ['í”¼ìŠ¤í†¤', 'ì”°', 'ë¶€íŠ¸', 'í•€', 'í•€ë¶€íŠ¸'];
          prefixes.forEach(pre => {
            const val = p[`${pre}${i}`];
            if (val) fields.push(val.trim());
          });
        }
        return fields.includes(partCode);
      });

      let usedHTML = usedIn.map(p => {
        const code = p['ì½”ë“œ'] || p._id;
        const model = (p['ì½”ë“œëª¨ë¸ëª…'] || '').replace(code + '_', '');
        return `
          <div class="part-used-item" onclick="closePartDetail(); setTimeout(()=>openDetail('${p._id}'), 350);">
            <div>
              <div style="font-family:'JetBrains Mono',monospace; font-weight:600; font-size:14px;">${code}</div>
              <div style="font-size:12px; color:var(--text-muted);">${model}</div>
            </div>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg>
          </div>
        `;
      }).join('');

      body.innerHTML = `
        <div class="section" style="margin-top:24px;">
          <div class="section-title">ë¶€í’ˆ ì •ë³´</div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">ë¶€í’ˆì½”ë“œ</div>
              <div class="info-value">${partCode}</div>
            </div>
            <div class="info-item">
              <div class="info-label">êµ¬ë¶„</div>
              <div class="info-value">${partType}</div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">ìƒì„¸ ìŠ¤í™</div>
          <div class="part-spec-coming">
            <div class="part-spec-coming-icon">ğŸ“</div>
            <div class="part-spec-coming-text">
              ìƒì„¸ ìŠ¤í™ ë°ì´í„° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.<br>
              ì¶”í›„ ì¹˜ìˆ˜, ì‚¬ì§„ ë“±ì´ ì¶”ê°€ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">ì‚¬ìš© ì œí’ˆ (${usedIn.length}ê°œ)</div>
          <div class="part-used-in">${usedHTML || '<div class="bom-empty">ì´ ë¶€í’ˆì„ ì‚¬ìš©í•˜ëŠ” ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>'}</div>
        </div>
      `;

      document.getElementById('partDetailView').classList.add('active');
    }

    function closePartDetail() {
      document.getElementById('partDetailView').classList.remove('active');
    }

    // ===== Back button handling =====
    window.addEventListener('popstate', (e) => {
      if (document.getElementById('partDetailView').classList.contains('active')) {
        closePartDetail();
      } else if (document.getElementById('detailView').classList.contains('active')) {
        closeDetail();
      }
    });

    // Push state when opening details
    const origOpenDetail = openDetail;
    openDetail = function(id) {
      history.pushState({ view: 'detail', id }, '');
      origOpenDetail(id);
    };

    const origOpenPartDetail = openPartDetail;
    openPartDetail = function(code, type) {
      history.pushState({ view: 'part', code, type }, '');
      origOpenPartDetail(code, type);
    };

    // ===== Startup =====
    (function() {
      const config = getConfig();
      if (config) {
        initApp(config);
      }
      // else: setup screen is already visible
    })();
  </script>
</body>
</html>
